import React, { useMemo } from 'react';
import { motion } from 'framer-motion';
import {
  CategorySection,
  CategoryTitle,
  ContentContainer,
  DropdownContainer,
  IconContainer,
  ResultDescription,
  ResultItem,
  ResultTitle,
  ScrollContent,
} from './style';
import { SearchDropdownProps, SearchResultType } from './types';
import { filterSearchResults, transformSearchData } from './utils';

// 图标 SVG
const ComponentIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="20"
    height="19"
    viewBox="0 0 20 19"
    fill="none"
  >
    <g clipPath="url(#clip0_459_4235)">
      <path
        d="M9.99894 12.5363L8.01815 14.5163V14.5167L9.99894 16.4967L11.9801 14.5167V14.5163L9.99894 12.5363ZM4.4834 5.35286C4.89764 5.3529 5.29589 5.50711 5.60156 5.78377L5.66178 5.84074L7.64258 7.82153C7.95499 8.13404 8.13041 8.55803 8.13045 8.99992C8.13045 9.41424 7.97628 9.81278 7.69954 10.1185L7.64258 10.1783L5.66178 12.1595C5.34927 12.4719 4.92529 12.6473 4.4834 12.6474C4.0415 12.6474 3.61755 12.4719 3.30501 12.1595L1.32381 10.1783C1.01142 9.86577 0.835938 9.44181 0.835938 8.99992C0.835977 8.55803 1.0114 8.13404 1.32381 7.82153L3.30501 5.84074L3.36483 5.78377C3.67054 5.50704 4.06908 5.35286 4.4834 5.35286ZM15.5149 5.35286C15.9292 5.35286 16.3277 5.507 16.6335 5.78377L16.6933 5.84074L18.6741 7.82153C18.9865 8.13404 19.1623 8.55803 19.1624 8.99992C19.1624 9.44186 18.9865 9.86576 18.6741 10.1783L16.6933 12.1595C16.3807 12.4719 15.9568 12.6474 15.5149 12.6474C15.073 12.6474 14.649 12.4719 14.3365 12.1595V12.1591L12.3565 10.1783C12.0441 9.86576 11.8682 9.44186 11.8682 8.99992C11.8683 8.58566 12.0229 8.18743 12.2996 7.88175L12.3565 7.82153L14.3365 5.84074L14.3963 5.78377C14.702 5.50699 15.1005 5.35287 15.5149 5.35286ZM2.5026 8.99992L4.48299 10.9803L6.46379 8.99992L4.48299 7.01912L2.5026 8.99992ZM9.99894 -0.163086C10.4408 -0.163086 10.8648 0.0123997 11.1773 0.324788L13.1585 2.30599C13.4709 2.61853 13.6464 3.04248 13.6464 3.48438C13.6464 3.92627 13.4709 4.35025 13.1585 4.66276H13.1581L11.1773 6.64274C10.8648 6.95516 10.4409 7.13062 9.99894 7.13062C9.55706 7.13058 9.13307 6.95516 8.82056 6.64274V6.64233L6.83976 4.66276C6.52734 4.35025 6.35192 3.92627 6.35189 3.48438C6.35189 3.04245 6.52733 2.61853 6.83976 2.30599L8.82056 0.324788L8.88078 0.267822C9.18644 -0.00881048 9.58473 -0.163048 9.99894 -0.163086ZM8.01815 3.48397L9.99894 5.46395L11.9797 3.48438L9.99894 1.50358L8.01815 3.48397ZM13.6468 14.5163C13.6468 14.7353 13.6037 14.9524 13.5199 15.1547C13.4465 15.3317 13.3431 15.4945 13.2147 15.6361L13.1581 15.6955L11.1773 17.6755C10.8648 17.9878 10.4408 18.1633 9.99894 18.1633C9.55715 18.1633 9.13345 17.9877 8.82096 17.6755L6.83976 15.6955V15.6951C6.68503 15.5404 6.56223 15.3568 6.47843 15.1547C6.39456 14.9524 6.35148 14.7353 6.35148 14.5163C6.35149 14.2973 6.3946 14.0805 6.47843 13.8783C6.56231 13.6759 6.68521 13.4919 6.84017 13.3371L8.82056 11.3575L8.88078 11.3005C9.18645 11.0238 9.58468 10.8693 9.99894 10.8692C10.4409 10.8692 10.8648 11.0451 11.1773 11.3575L13.1577 13.3371C13.3127 13.4919 13.436 13.6759 13.5199 13.8783C13.6037 14.0805 13.6468 14.2973 13.6468 14.5163ZM15.5149 10.9807L17.4953 8.99992L15.5149 7.01912L13.5353 8.99992L15.5149 10.9807Z"
        fill="#2300A6"
        fillOpacity="0.698039"
      />
    </g>
    <defs>
      <clipPath id="clip0_459_4235">
        <rect width="20" height="20" fill="white" transform="translate(0 -1)" />
      </clipPath>
    </defs>
  </svg>
);

const DemoIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="20"
    height="20"
    viewBox="0 0 20 20"
    fill="none"
  >
    <path
      d="M17.5007 7.5H2.50065V15C2.50065 15.4602 2.87375 15.8333 3.33398 15.8333H16.6673C17.1276 15.8333 17.5007 15.4602 17.5007 15V7.5ZM7.50065 11.6667C7.50065 11.2064 7.12756 10.8333 6.66732 10.8333C6.20708 10.8333 5.83398 11.2064 5.83398 11.6667C5.83398 12.1269 6.20708 12.5 6.66732 12.5C7.12756 12.5 7.50065 12.1269 7.50065 11.6667ZM14.1673 11.6667C14.1673 11.2064 13.7942 10.8333 13.334 10.8333C12.8737 10.8333 12.5007 11.2064 12.5007 11.6667C12.5007 12.1269 12.8737 12.5 13.334 12.5C13.7942 12.5 14.1673 12.1269 14.1673 11.6667ZM17.5007 5C17.5007 4.53976 17.1276 4.16667 16.6673 4.16667H3.33398C2.87375 4.16667 2.50065 4.53976 2.50065 5V5.83333H17.5007V5ZM15.834 11.6667C15.834 13.0474 14.7147 14.1667 13.334 14.1667C11.9533 14.1667 10.834 13.0474 10.834 11.6667C10.834 11.3744 10.8846 11.094 10.9768 10.8333H9.0245C9.11666 11.094 9.16732 11.3744 9.16732 11.6667C9.16732 13.0474 8.04803 14.1667 6.66732 14.1667C5.28661 14.1667 4.16732 13.0474 4.16732 11.6667C4.16732 10.286 5.28661 9.16667 6.66732 9.16667H13.334C14.7147 9.16667 15.834 10.286 15.834 11.6667ZM19.1673 15C19.1673 16.3807 18.048 17.5 16.6673 17.5H3.33398C1.95327 17.5 0.833984 16.3807 0.833984 15V5C0.833984 3.61929 1.95327 2.5 3.33398 2.5H16.6673C18.048 2.5 19.1673 3.61929 19.1673 5V15Z"
      fill="#356B00"
      fillOpacity="0.866667"
    />
  </svg>
);

const DocIcon = () => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="20"
    height="20"
    viewBox="0 0 20 20"
    fill="none"
  >
    <path
      d="M2.5 16.6666V3.33325C2.5 2.67021 2.76358 2.03451 3.23242 1.56567C3.70126 1.09683 4.33696 0.833252 5 0.833252H11.6667V0.833659C12.0399 0.833232 12.4095 0.906072 12.7543 1.04891C13.0996 1.19195 13.4134 1.40186 13.6772 1.66659H13.6768L16.6642 4.65405L16.7611 4.75537C16.9811 4.99691 17.158 5.27488 17.2835 5.57731C17.4268 5.92258 17.5004 6.29277 17.5 6.66659V16.6666C17.5 17.3296 17.2364 17.9653 16.7676 18.4342C16.2987 18.903 15.663 19.1666 15 19.1666H5C4.33696 19.1666 3.70126 18.903 3.23242 18.4342C2.76358 17.9653 2.5 17.3296 2.5 16.6666ZM13.3333 13.3333C13.7936 13.3333 14.1667 13.7063 14.1667 14.1666C14.1667 14.6268 13.7936 14.9999 13.3333 14.9999H6.66667C6.20643 14.9999 5.83333 14.6268 5.83333 14.1666C5.83333 13.7063 6.20643 13.3333 6.66667 13.3333H13.3333ZM13.3333 9.99992C13.7936 9.99992 14.1667 10.373 14.1667 10.8333C14.1667 11.2935 13.7936 11.6666 13.3333 11.6666H6.66667C6.20643 11.6666 5.83333 11.2935 5.83333 10.8333C5.83333 10.373 6.20643 9.99992 6.66667 9.99992H13.3333ZM8.33333 6.66659C8.79357 6.66659 9.16667 7.03968 9.16667 7.49992C9.16667 7.96016 8.79357 8.33325 8.33333 8.33325H6.66667C6.20643 8.33325 5.83333 7.96016 5.83333 7.49992C5.83333 7.03968 6.20643 6.66659 6.66667 6.66659H8.33333ZM15.4867 5.83325L12.5 2.8466V5.83325H15.4867ZM4.16667 16.6666C4.16667 16.8876 4.25453 17.0995 4.41081 17.2558C4.56709 17.4121 4.77899 17.4999 5 17.4999H15C15.221 17.4999 15.4329 17.4121 15.5892 17.2558C15.7455 17.0995 15.8333 16.8876 15.8333 16.6666V7.49992H12.5C12.058 7.49992 11.6342 7.3242 11.3216 7.01164C11.0091 6.69908 10.8333 6.27528 10.8333 5.83325V2.49992H5C4.77899 2.49992 4.56709 2.58778 4.41081 2.74406C4.25453 2.90034 4.16667 3.11224 4.16667 3.33325V16.6666Z"
      fill="#007B95"
    />
  </svg>
);

const iconMap = {
  component: ComponentIcon,
  demo: DemoIcon,
  doc: DocIcon,
};

const containerVariants = {
  hidden: { opacity: 0, y: -10 },
  visible: {
    opacity: 1,
    y: 0,
    transition: {
      staggerChildren: 0.05,
      delayChildren: 0.1,
    },
  },
};

const itemVariants = {
  hidden: { opacity: 0, y: 10 },
  visible: {
    opacity: 1,
    y: 0,
    transition: { type: 'spring' as const, stiffness: 300, damping: 24 },
  },
};

const SearchDropdown: React.FC<SearchDropdownProps> = ({
  visible,
  searchValue,
  onClose,
}) => {
  // 重组数据（只在组件首次渲染时执行一次）
  const allResults = useMemo(() => transformSearchData(), []);

  // 根据搜索关键词过滤数据
  const filteredResults = useMemo(
    () => filterSearchResults(searchValue, allResults),
    [searchValue, allResults],
  );

  // 根据类型分组
  const groupedResults = useMemo(() => {
    return filteredResults.reduce(
      (acc, item) => {
        if (!acc[item.type]) {
          acc[item.type] = [];
        }
        acc[item.type].push(item);
        return acc;
      },
      {} as Record<SearchResultType, Array<(typeof filteredResults)[number]>>,
    );
  }, [filteredResults]);

  const typeOrder: SearchResultType[] = ['component', 'demo', 'doc'];
  const typeLabels = {
    component: 'COMPONENT',
    demo: 'DEMO',
    doc: 'DOC',
  };

  return (
    <DropdownContainer $visible={visible}>
      <ScrollContent>
        <motion.div
          variants={containerVariants}
          initial="hidden"
          animate={visible ? 'visible' : 'hidden'}
        >
          {typeOrder.map((type) => {
            const items = groupedResults[type];
            if (!items || items.length === 0) return null;

            const IconComponent = iconMap[type];

            return (
              <CategorySection key={type}>
                <CategoryTitle>{typeLabels[type]}</CategoryTitle>
                {items.map((item) => (
                  <motion.div key={item.id} variants={itemVariants}>
                    <ResultItem
                      href={item.url}
                      onClick={(e) => {
                        e.preventDefault();
                        onClose();
                        if (item.url) {
                          window.open(
                            item.url,
                            '_blank',
                            'noopener,noreferrer',
                          );
                        }
                      }}
                    >
                      <IconContainer $type={type}>
                        <IconComponent />
                      </IconContainer>
                      <ContentContainer>
                        <ResultTitle>{item.title}</ResultTitle>
                        <ResultDescription>
                          {item.description}
                        </ResultDescription>
                      </ContentContainer>
                    </ResultItem>
                  </motion.div>
                ))}
              </CategorySection>
            );
          })}
        </motion.div>
      </ScrollContent>
    </DropdownContainer>
  );
};

export default SearchDropdown;
